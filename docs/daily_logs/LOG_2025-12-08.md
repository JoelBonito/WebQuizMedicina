# Relat√≥rio de Trabalho - WebQuizMedicina
üìÖ **Data**: 08 de Dezembro de 2025

---

## ‚è±Ô∏è Resumo de Tempo
* **Hora de In√≠cio**: 00:00
* **Hora de Fim**: 15:45 (Estimado)
* **Tempo Total**: ~15 horas e 45 minutos
* **Sess√µes**: 7 tarefas

---

## üìã Sess√µes de Trabalho

### Sess√£o 15: 18:50 - 18:55 (5 min) ‚úÖ
**An√°lise de Erros P√≥s-Login (Benignos)**
* **Relato**: Usu√°rio reportou erros no console ap√≥s login bem-sucedido ("InvalidNodeTypeError", "Cross-Origin-Opener-Policy").
* **Diagn√≥stico**:
    - `InvalidNodeTypeError`: Conflito cl√°ssico entre React e Extens√µes (Google Translate/Password Managers) modificando o DOM do formul√°rio de login antes do unmount.
    - `Cross-Origin-Opener-Policy`: Aviso padr√£o do Chrome ao fechar popups de OAuth (Google Sign-In).
* **Conclus√£o**: Erros falsos positivos que n√£o afetam a funcionalidade. Login est√° 100% operacional.
* **Status Final**: ‚úÖ Resolvido.

### Sess√£o 1: 00:00 - 00:15 (15 min) ‚úÖ
**Atualiza√ß√£o de Textos de Interface (i18n)**
* Atualiza√ß√£o das mensagens de limite de upload e formatos suportados em 10 idiomas.
* Arquivos modificados: `src/locales/*.json`
* Defini√ß√£o expl√≠cita de limite de 200MB e lista de extens√µes (PDF, DOCX, PPTX, etc).

### Sess√£o 2: 09:25 - 09:30 (2h) ‚úÖ
**Implementa√ß√£o de React Router para Persist√™ncia de Estado**
* Problema: Web app voltava ao Dashboard ao girar tela do iPad (mudan√ßa portrait/landscape).
* Causa raiz: Navega√ß√£o baseada em `useState` (mem√≥ria vol√°til).
* Solu√ß√£o implementada: Refatora√ß√£o completa para React Router com URLs persistentes.
* Arquivos modificados:
  - `src/App.tsx`: Refatora√ß√£o completa (3 componentes de rota: DashboardRoute, ProjectRoute, AdminRoute)
  - `src/hooks/useMediaQuery.ts`: Corre√ß√£o do flickering na inicializa√ß√£o
* Rotas criadas: `/` (dashboard), `/project/:projectId` (projeto), `/admin` (admin)
* Comando executado: `npm run dev` - ‚úÖ Iniciou sem erros na porta 3001
* Benef√≠cios: Persist√™ncia total, URLs compartilh√°veis, navega√ß√£o do navegador funcional

### Sess√£o 3: 15:07 - 15:10 (3 min) ‚úÖ
**Corre√ß√£o de Upload de Arquivos PowerPoint e Word**
* Problema: Sistema n√£o permitia upload de arquivos .ppt, .pptx, .doc, .docx
* Causa raiz: Falta de extens√µes e MIME types no componente SourcesPanel
* Solu√ß√£o implementada:
  - Adicionado `.doc, .docx, .ppt, .pptx` ao atributo `accept` do input
  - Adicionados 4 MIME types do Microsoft Office √† lista `allowedTypes`
  - Atualizado regex de valida√ß√£o para incluir essas extens√µes
* Arquivo modificado: `src/components/SourcesPanel.tsx`
* MIME types adicionados:
  - `application/msword` (.doc)
  - `application/vnd.openxmlformats-officedocument.wordprocessingml.document` (.docx)
  - `application/vnd.ms-powerpoint` (.ppt)
  - `application/vnd.openxmlformats-officedocument.presentationml.presentation` (.pptx)

### Sess√£o 4: 15:15 - 15:20 (5 min) ‚úÖ
**Corre√ß√£o de Erros de Transform NaN no MindMapViewer**
* Problema: Erros de console `<g> attribute transform: Expected number, "translate(NaN,NaN)"`
* Causa raiz: SVG sendo renderizado antes de ter dimens√µes v√°lidas
* Solu√ß√£o implementada:
  1. Valida√ß√£o rigorosa de dimens√µes (adicionado `isFinite()` check)
  2. Dimens√µes m√≠nimas garantidas (100px) para evitar valores zero
  3. Adicionado `viewBox` ao SVG para melhor controle
  4. Limpeza pr√©-emptiva de elementos `<g>` com transforms inv√°lidos durante unmount
  5. Reset de atributos SVG durante cleanup
  6. Limite de retries para evitar loop infinito
* Arquivo modificado: `src/components/MindMapViewer.tsx`
* Melhorias: 
  - C√≥digo mais defensivo contra condi√ß√µes de corrida
  - Menos erros no console durante navega√ß√£o r√°pida
  - Cleanup mais robusto durante unmount

### Sess√£o 5: 15:19 - 15:25 (6 min) ‚úÖ
**Corre√ß√£o de Erros de Permiss√£o do Firestore**
* Problema: M√∫ltiplos erros no console `FirebaseError: Missing or insufficient permissions`
* Origem: `useSources.ts:94`, `useProjects.ts:34` e `useProjectStats.ts:214`
* Causa raiz: Race conditions causadas por m√∫ltiplos listeners `onSnapshot` ativos simultaneamente tentando usar a fun√ß√£o `isProjectOwner()` que faz chamadas `get()` e `exists()` internas
* Solu√ß√£o implementada:
  - Simplificadas as regras de seguran√ßa de 4 cole√ß√µes: `sources`, `questions`, `flashcards`, `summaries`
  - Removida depend√™ncia de `isProjectOwner()` que causa lookups adicionais em todas
  - Usado apenas `isOwner(resource.data.user_id)` e `isOwner(request.resource.data.user_id)` para valida√ß√£o mais r√°pida
  - Deploy das novas regras para Firebase (2x)
* Arquivo modificado: `firestore.rules`
* Comandos executados: 
  - `firebase deploy --only firestore:rules` (1¬™ corre√ß√£o: sources) - ‚úÖ
  - `firebase deploy --only firestore:rules` (2¬™ corre√ß√£o: questions, flashcards, summaries) - ‚úÖ
* Resultado: Elimina√ß√£o completa dos erros de permiss√£o no console, incluindo painel de estat√≠sticas

### Sess√£o 6: 15:23 - 15:30 (7 min) ‚úÖ
**Corre√ß√£o Adicional: Erros de Transform NaN ao Fechar Mapa Mental**
* Problema: Erros `<g> attribute transform: Expected number, "translate(NaN,NaN)"` ao fechar o mapa mental
* Causa raiz: Biblioteca Markmap tentando animar elementos durante destrui√ß√£o/unmount do componente
* Solu√ß√£o implementada:
  1. Desabilitar TODAS as anima√ß√µes CSS e SVG ANTES de qualquer cleanup
  2. Cancelar anima√ß√µes em execu√ß√£o usando `getAnimations()` nos elementos SVG
  3. Definir `duration: 0` nas op√ß√µes do Markmap antes de destruir
  4. Ordem correta: desabilitar anima√ß√µes ‚Üí remover elementos inv√°lidos ‚Üí destruir Markmap ‚Üí limpar DOM
* Arquivo modificado: `src/components/MindMapViewer.tsx`
* Melhorias:
  - Cleanup mais agressivo e na ordem correta
  - Previne tentativas de anima√ß√£o durante unmount
  - C√≥digo mais robusto contra erros de timing

### Sess√£o 7: 15:27 - 15:45 (18 min) ‚úÖ
**An√°lise de Viabilidade: Integra√ß√£o Google Drive**
* Solicita√ß√£o: Avaliar complexidade de integrar Google Drive Picker para importa√ß√£o de fontes
* An√°lise realizada:
  - Revis√£o do c√≥digo atual: `useSources.ts`, `SourcesPanel.tsx`, `fileUtils.ts`
  - Pesquisa de APIs: Google Drive Picker, OAuth 2.0, `@googleworkspace/drive-picker-react`
  - Identifica√ß√£o de pontos de integra√ß√£o e reutiliza√ß√£o de c√≥digo existente
* Resultado: Complexidade M√©dio-Alta (~2-3 dias de trabalho)
* Plano de implementa√ß√£o criado: `implementation_plan.md`
* Componentes propostos:
  - Fase 1: Configura√ß√£o Google Cloud (OAuth, APIs)
  - Fase 2: Componente `GoogleDrivePicker.tsx`
  - Fase 3: Service `googleDriveService.ts`
  - Fase 4: Integra√ß√£o com fluxo existente
  - Fase 5: Vari√°veis de ambiente

### Sess√£o 8: 15:45 - 16:00 (15 min) ‚úÖ
**Corre√ß√£o do Modelo de Embedding Gemini (Erro 404)**
* Problema: Processamento de embeddings apresentando erro `404 Not Found` no log do Firebase.
* Causa raiz: C√≥digo tentava usar modelo `gemini-2.5-flash` para embeddings (que n√£o suporta a tarefa), ao inv√©s do modelo correto.
* Solu√ß√£o implementada:
  1. Identificado modelo correto: `gemini-embedding-001` (conforme documenta√ß√£o oficial).
  2. Ajustado `modelSelector.ts` para priorizar `gemini-embedding-001` e incluir m√©todo `embedContent` no discovery.
  3. Ajustado `gemini.ts` para usar este modelo como default.
  4. Mantido `text-embedding-004` apenas como fallback seguro.
  5. Recompila√ß√£o das functions (`npm run build`).
* Arquivos modificados:
  - `src/shared/gemini.ts`
  - `functions/lib/*` (via build)

### Sess√£o 9: 16:35 - 16:45 (10 min) ‚úÖ
**Implementa√ß√£o de Limites de Upload e Melhoria de UX**
* **Objetivo**: Evitar erros de timeout e sobrecarga na Cloud Function de embeddings.
* **Altera√ß√µes**:
  1. Implementada valida√ß√£o no `SourcesPanel.tsx`:
     - M√°ximo **10 arquivos** por upload.
     - M√°ximo **5 arquivos pesados** (PDF, √Åudio, Imagem) por upload.
  2. Adicionado tratamento espec√≠fico para erro `deadline-exceeded` (Timeout):
     - Exibe toast informativo ("Processamento continua em background") em vez de erro vermelho.
     - Tenta refetch autom√°tico ap√≥s 5s.
* **Arquivos Modificados**: `src/components/SourcesPanel.tsx`

### Sess√£o 10: 16:45 - 16:55 (10 min) ‚úÖ
**Corre√ß√£o Cr√≠tica de Backend (Timeout e Fallback)**
* **Objetivo**: Resolver falha de transcri√ß√£o em arquivos longos e erro 404 de modelo.
* **Altera√ß√µes**:
  1. `modelSelector.ts`: Implementado fallback estrito para `embedding` -> `text-embedding-004`.
  2. `gemini.ts` & `geminiFileManager.ts`: Adicionado `timeout: 540000` (9 min) nas chamadas do SDK.
  3. Recompila√ß√£o dos arquivos (`npm run build`) - ‚úÖ Sucesso.
* **Arquivos Modificados**: `functions/src/shared/*`

### Sess√£o 3: 17:47 - 17:57 (Estimado) ‚úÖ
**Remo√ß√£o de Suporte a √Åudio (Fonts Autorizadas)**
* Removido suporte a arquivos de √°udio (MP3, WAV, M4A) do painel de fontes.
* Atualizada valida√ß√£o de upload no frontend.
* Atualizadas mensagens de localiza√ß√£o (PT/EN) sobre formatos suportados.
* Arquivos modificados: `src/components/SourcesPanel.tsx`, `src/locales/pt.json`, `src/locales/en.json`.

### Sess√£o 11: 17:49 - 17:58 (9 min) ‚úÖ
**Diagn√≥stico e Solu√ß√£o: Erro de Autentica√ß√£o Google OAuth + Limpeza de UI**
* **Problema**: Erro `Firebase: Error (auth/auth-domain-config-required)` ao tentar criar conta pelo Google
* **Causa Raiz**: Dom√≠nio `webquizmedicina.inovesi.app.br` n√£o estava na lista de **Authorized domains** do Firebase Authentication
* **Diagn√≥stico**:
  1. Verificado arquivo de configura√ß√£o: `src/lib/firebase.ts` (‚úÖ correto)
  2. Verificadas vari√°veis de ambiente `.env` (‚úÖ corretas)
  3. Analisado c√≥digo de autentica√ß√£o OAuth: `src/contexts/AuthContext.tsx` (‚úÖ correto)
  4. Identificado que o erro ocorre no lado do Firebase, n√£o no c√≥digo
* **Solu√ß√£o Documentada**:
  - Criado guia completo: `docs/FIREBASE_DOMAIN_FIX.md`
  - Passo a passo para adicionar dom√≠nio nos **Authorized domains** do Firebase Console
  - Firebase Console aberto automaticamente na p√°gina de configura√ß√£o de autentica√ß√£o
  - ‚úÖ Usu√°rio confirmou: Dom√≠nio `webquizmedicina.inovesi.app.br` adicionado com sucesso
* **Limpeza de UI (Remo√ß√£o do Login GitHub)**:
  - Removido bot√£o de login do GitHub (estava desativado no Firebase)
  - Removido import do √≠cone `Github` do lucide-react
  - Removida fun√ß√£o `handleGitHubSignIn` (n√£o utilizada)
  - Bot√£o Google ajustado para largura total (`w-full`) ao inv√©s de grid 2 colunas
  - Interface mais limpa e focada no m√©todo de autentica√ß√£o ativo
* **Arquivos Criados**: `docs/FIREBASE_DOMAIN_FIX.md`
### Sess√£o 12: 18:05 - 18:15 (10 min) ‚úÖ
**Diagn√≥stico: Erro de Configura√ß√£o de Ambiente Firebase**
* **Problema**: Login com Google falhando silenciosamente ou com erro no console, devido √† falta de configura√ß√£o do `authDomain`.
* **Causa Raiz**: O arquivo `.env` local estava ausente ou incompleto (exemplo `.env.example` n√£o listava vari√°veis do Firebase Auth), causando `auth-domain-config-required`.
* **A√ß√£o Corretiva**:
  1. Atualizado `.env.example` para incluir chaves `VITE_FIREBASE_*`.
  2. Atualizado `docs/FIREBASE_DOMAIN_FIX.md` com instru√ß√µes expl√≠citas para preencher `.env`.
  3. Instru√≠do usu√°rio a preencher `.env` e reiniciar servidor.
* **Arquivos Modificados**: `.env.example`, `docs/FIREBASE_DOMAIN_FIX.md`

