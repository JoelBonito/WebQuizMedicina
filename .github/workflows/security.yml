name: Security Checks

on:
  push:
    branches: [ main, develop, claude/** ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security audit weekly on Mondays at 10:00 AM UTC
    - cron: '0 10 * * 1'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # ============================================
  # NPM SECURITY AUDIT
  # ============================================
  npm-audit:
    name: NPM Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Run npm audit (production only)
        run: npm audit --production --audit-level=high

      - name: Generate audit report
        if: always()
        run: |
          npm audit --json > npm-audit-report.json
          echo "## NPM Audit Results" >> $GITHUB_STEP_SUMMARY
          npm audit >> $GITHUB_STEP_SUMMARY || true

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit-report.json
          retention-days: 30

  # ============================================
  # DEPENDENCY REVIEW (PR only)
  # ============================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0

  # ============================================
  # CODE SCANNING (SAST)
  # ============================================
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript', 'typescript' ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  # ============================================
  # SECURITY HEADERS CHECK
  # ============================================
  security-headers:
    name: Security Headers Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check security headers in Edge Functions
        run: |
          echo "Checking for security headers in Edge Functions..."

          # Check for CORS headers
          if ! grep -r "X-Content-Type-Options" supabase/functions/_shared/; then
            echo "::warning::Missing X-Content-Type-Options header"
          fi

          if ! grep -r "X-Frame-Options" supabase/functions/_shared/; then
            echo "::warning::Missing X-Frame-Options header"
          fi

          if ! grep -r "Content-Security-Policy" supabase/functions/_shared/; then
            echo "::warning::Missing Content-Security-Policy header"
          fi

          echo "Security headers check completed"

  # ============================================
  # SECRETS SCANNING
  # ============================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better detection

      - name: TruffleHog Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # ============================================
  # OWASP DEPENDENCY CHECK
  # ============================================
  owasp-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        env:
          JAVA_HOME: /opt/jdk
        with:
          project: 'WebQuizMedicina'
          path: '.'
          format: 'HTML'
          args: >
            --enableRetired
            --enableExperimental

      - name: Upload OWASP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: reports
          retention-days: 30

  # ============================================
  # CUSTOM SECURITY TESTS
  # ============================================
  security-tests:
    name: Custom Security Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for hardcoded secrets..."

          # Check for API keys
          if grep -r "VITE_SUPABASE_ANON_KEY\s*=\s*['\"]ey" src/ --include="*.ts" --include="*.tsx"; then
            echo "::error::Found hardcoded Supabase key"
            exit 1
          fi

          # Check for hardcoded URLs in production code
          if grep -r "localhost:3000" src/ --include="*.ts" --include="*.tsx"; then
            echo "::warning::Found hardcoded localhost URL"
          fi

          echo "Secret check completed"

      - name: Check for vulnerable patterns
        run: |
          echo "Checking for vulnerable code patterns..."

          # Check for dangerouslySetInnerHTML without sanitization
          FILES_WITH_DANGEROUS_HTML=$(grep -r "dangerouslySetInnerHTML" src/ --include="*.tsx" -l || true)
          if [ -n "$FILES_WITH_DANGEROUS_HTML" ]; then
            echo "::warning::Found dangerouslySetInnerHTML usage. Ensure content is sanitized:"
            echo "$FILES_WITH_DANGEROUS_HTML"
          fi

          # Check for eval usage
          if grep -r "\beval\(" src/ --include="*.ts" --include="*.tsx"; then
            echo "::error::Found eval() usage - potential security risk"
            exit 1
          fi

          echo "Pattern check completed"

      - name: Validate environment variables
        run: |
          echo "Checking .env.example..."

          if [ ! -f ".env.example" ]; then
            echo "::error::.env.example file not found"
            exit 1
          fi

          # Ensure no real secrets in .env.example
          if grep -E "(ey[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+|[0-9a-f]{32})" .env.example; then
            echo "::error::Found potential real secrets in .env.example"
            exit 1
          fi

          echo "Environment variables validated"

  # ============================================
  # SECURITY SUMMARY
  # ============================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [npm-audit, security-headers, secret-scan, security-tests]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- NPM Audit: ${{ needs.npm-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Headers: ${{ needs.security-headers.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Scanning: ${{ needs.secret-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Tests: ${{ needs.security-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scan completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY
