name: Deploy Supabase Edge Functions

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/functions/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v1.x

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Shared Files
        run: |
          echo "üîç Checking shared files..."
          ls -la supabase/functions/_shared/
          echo ""
          echo "Files found:"
          echo "- security.ts: $(test -f supabase/functions/_shared/security.ts && echo '‚úÖ' || echo '‚ùå')"
          echo "- validation.ts: $(test -f supabase/functions/_shared/validation.ts && echo '‚úÖ' || echo '‚ùå')"
          echo "- audit.ts: $(test -f supabase/functions/_shared/audit.ts && echo '‚úÖ' || echo '‚ùå')"
          echo "- gemini.ts: $(test -f supabase/functions/_shared/gemini.ts && echo '‚úÖ' || echo '‚ùå')"
          echo "- cors.ts: $(test -f supabase/functions/_shared/cors.ts && echo '‚úÖ' || echo '‚ùå')"

      - name: Deploy Edge Functions with Shared Dependencies
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: bwgglfforazywrjhbxsa
        run: |
          echo "üöÄ Deploying Edge Functions with shared dependencies..."
          echo ""
          echo "‚ÑπÔ∏è  The Supabase CLI automatically bundles _shared files during deployment"
          echo ""
          
          echo "üì¶ Deploying chat function..."
          supabase functions deploy chat --project-ref $SUPABASE_PROJECT_ID --no-verify-jwt
          
          echo "üì¶ Deploying generate-quiz function..."
          supabase functions deploy generate-quiz --project-ref $SUPABASE_PROJECT_ID --no-verify-jwt
          
          echo "üì¶ Deploying generate-flashcards function..."
          supabase functions deploy generate-flashcards --project-ref $SUPABASE_PROJECT_ID --no-verify-jwt
          
          echo "üì¶ Deploying generate-summary function..."
          supabase functions deploy generate-summary --project-ref $SUPABASE_PROJECT_ID --no-verify-jwt
          
          echo "üì¶ Deploying generate-focused-summary function..."
          supabase functions deploy generate-focused-summary --project-ref $SUPABASE_PROJECT_ID --no-verify-jwt

      - name: Environment Variables Reminder
        run: |
          echo ""
          echo "‚öôÔ∏è  Environment variables are managed in Supabase Dashboard"
          echo "Required secrets:"
          echo "  - GEMINI_API_KEY"
          echo "  - ALLOWED_ORIGIN (optional, for CORS)"
          echo ""
          echo "Configure at: https://supabase.com/dashboard/project/bwgglfforazywrjhbxsa/settings/functions"

      - name: Deployment Summary
        run: |
          echo ""
          echo "‚úÖ All Edge Functions deployed successfully!"
          echo ""
          echo "üì¶ Functions deployed:"
          echo "  - chat"
          echo "  - generate-quiz"
          echo "  - generate-flashcards"
          echo "  - generate-summary"
          echo "  - generate-focused-summary"
          echo ""
          echo "üîß Shared dependencies bundled (_shared folder):"
          echo "  - security.ts (auth, rate limiting, CORS)"
          echo "  - validation.ts (input validation, sanitization)"
          echo "  - audit.ts (logging)"
          echo "  - gemini.ts (AI API client)"
          echo "  - cors.ts (CORS headers)"
          echo ""
          echo "üîê Next steps:"
          echo "  1. Set GEMINI_API_KEY in Supabase Dashboard"
          echo "  2. Set ALLOWED_ORIGIN for production CORS"
          echo "  3. Test endpoints at: https://bwgglfforazywrjhbxsa.supabase.co/functions/v1/"
