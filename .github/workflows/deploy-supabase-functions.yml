name: Deploy Supabase Edge Functions

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/functions/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v1.x

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Shared Files
        run: |
          echo "ğŸ” Checking shared files..."
          ls -la supabase/functions/_shared/
          echo ""
          echo "Files found:"
          echo "- security.ts: $(test -f supabase/functions/_shared/security.ts && echo 'âœ…' || echo 'âŒ')"
          echo "- validation.ts: $(test -f supabase/functions/_shared/validation.ts && echo 'âœ…' || echo 'âŒ')"
          echo "- audit.ts: $(test -f supabase/functions/_shared/audit.ts && echo 'âœ…' || echo 'âŒ')"
          echo "- gemini.ts: $(test -f supabase/functions/_shared/gemini.ts && echo 'âœ…' || echo 'âŒ')"
          echo "- embeddings.ts: $(test -f supabase/functions/_shared/embeddings.ts && echo 'âœ…' || echo 'âŒ')"
          echo "- output-limits.ts: $(test -f supabase/functions/_shared/output-limits.ts && echo 'âœ…' || echo 'âŒ')"
          echo "- cors.ts: $(test -f supabase/functions/_shared/cors.ts && echo 'âœ…' || echo 'âŒ')"

      - name: Auto-detect and Deploy All Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: bwgglfforazywrjhbxsa
        run: |
          echo "ğŸš€ Auto-detecting Edge Functions..."
          echo ""
          
          # Find all directories in supabase/functions/ except _shared
          FUNCTIONS=$(find supabase/functions -mindepth 1 -maxdepth 1 -type d ! -name '_shared' -exec basename {} \;)
          
          if [ -z "$FUNCTIONS" ]; then
            echo "âŒ No Edge Functions found!"
            exit 1
          fi
          
          echo "ğŸ“¦ Found Edge Functions:"
          for func in $FUNCTIONS; do
            echo "  - $func"
          done
          echo ""
          
          # Deploy each function
          DEPLOYED=0
          FAILED=0
          
          for func in $FUNCTIONS; do
            echo "ğŸš€ Deploying $func..."
            if supabase functions deploy $func --project-ref $SUPABASE_PROJECT_ID --no-verify-jwt; then
              echo "âœ… $func deployed successfully"
              DEPLOYED=$((DEPLOYED + 1))
            else
              echo "âŒ Failed to deploy $func"
              FAILED=$((FAILED + 1))
            fi
            echo ""
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Deployment Summary:"
          echo "  âœ… Successfully deployed: $DEPLOYED"
          echo "  âŒ Failed: $FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ $FAILED -gt 0 ]; then
            exit 1
          fi

      - name: Environment Variables Reminder
        if: success()
        run: |
          echo ""
          echo "âš™ï¸  Environment variables are managed in Supabase Dashboard"
          echo "Required secrets:"
          echo "  - GEMINI_API_KEY"
          echo "  - ALLOWED_ORIGIN (optional, for CORS)"
          echo ""
          echo "Configure at: https://supabase.com/dashboard/project/bwgglfforazywrjhbxsa/settings/functions"

      - name: Deployment Complete
        if: success()
        run: |
          echo ""
          echo "âœ… All Edge Functions deployed successfully!"
          echo ""
          echo "ğŸ”§ Shared dependencies bundled (_shared folder):"
          echo "  - security.ts (auth, rate limiting, CORS)"
          echo "  - validation.ts (input validation, sanitization)"
          echo "  - audit.ts (logging)"
          echo "  - gemini.ts (AI API client)"
          echo "  - embeddings.ts (RAG, chunking, vector search)"
          echo "  - output-limits.ts (token management)"
          echo "  - cors.ts (CORS headers)"
          echo ""
          echo "ğŸ” Next steps:"
          echo "  1. Set GEMINI_API_KEY in Supabase Dashboard"
          echo "  2. Set ALLOWED_ORIGIN for production CORS"
          echo "  3. Test endpoints at: https://bwgglfforazywrjhbxsa.supabase.co/functions/v1/"
